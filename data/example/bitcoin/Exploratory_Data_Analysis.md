## Exploratory Data Analysis

### Using Spark
~~~
bin/spark-shell --master spark://localhost:7077 \
--packages com.databricks:spark-csv_2.10:1.3.0 \
--conf spark.serializer=org.apache.spark.serializer.KryoSerializer

import org.apache.spark.rdd.RDD
import org.apache.spark.storage.StorageLevel

val rawRDD = sc.textFile("/work/R/example/stocks/zyadoEUR.csv")

rawRDD.take(10).foreach(println)

1398372911,341.740000000000,0.150000000000
1398373075,341.740000000000,0.050000000000
1398377372,341.750000000000,0.142000000000
1398377372,341.750000000000,0.008000000000
1398384744,341.770000000000,0.012000000000
1398384744,341.750000000000,0.078000000000
1398384777,341.770000000000,0.090000000000
1398385616,341.740000000000,0.070000000000
1398386034,341.740000000000,0.060000000000
1398386798,341.770000000000,0.003000000000

rawRDD.count
Long = 1870266  


case class RawTicker(ts: Long, price: Float, volume: Float)

val rawDF = rawRDD.map(_.split(",")).map(row => RawTicker(row(0).toLong, row(1).toFloat, row(2).toFloat)).toDF()

rawDF.cache()

rawDF.show()

+----------+------+------+
|        ts| price|volume|
+----------+------+------+
|1398372911|341.74|  0.15|
|1398373075|341.74|  0.05|
|1398377372|341.75| 0.142|
|1398377372|341.75| 0.008|
|1398384744|341.77| 0.012|
|1398384744|341.75| 0.078|
|1398384777|341.77|  0.09|
|1398385616|341.74|  0.07|
|1398386034|341.74|  0.06|
|1398386798|341.77| 0.003|
|1398386798|341.87| 0.021|
|1398387965|342.54| 0.025|
|1398388834| 343.0| 0.123|
|1398436109| 343.0| 0.041|
|1398456998|343.54|  0.06|
|1398457108|344.21| 0.041|
|1398512419|344.21|  0.03|
|1398515509|344.23|  0.03|
|1398515533|344.23|  0.07|
|1398522460|344.21|  0.02|
+----------+------+------+

rawDF.registerTempTable("raw")

sqlContext.sql("SELECT MIN(ts), MAX(ts) FROM raw").show()

+----------+----------+                                                         
|       _c0|       _c1|
+----------+----------+
|1398372911|1451913138|
+----------+----------+

sqlContext.sql("SELECT count(*) FROM raw").show()

+-------+                                                                       
|    _c0|
+-------+
|1870266|
+-------+



case class TickerS(ts: String, date: String, price: Float, volume: Float)

import java.util.Date
import java.text.SimpleDateFormat

val sdf = new SimpleDateFormat("yyyy-MM-dd hh:mm:ss")
val sdf2 = new SimpleDateFormat("yyyy-MM-dd")

val df = rawRDD.map(_.split(",")).map {row => 
  val dt = new Date(row(0).toLong * 1000)
  TickerS(sdf.format(dt), sdf2.format(dt), row(1).toFloat, row(2).toFloat)
}.toDF()

df.cache()

df.show()

+-------------------+----------+------+------+
|                 ts|      date| price|volume|
+-------------------+----------+------+------+
|2014-04-24 04:55:11|2014-04-24|341.74|  0.15|
|2014-04-24 04:57:55|2014-04-24|341.74|  0.05|
|2014-04-24 06:09:32|2014-04-24|341.75| 0.142|
|2014-04-24 06:09:32|2014-04-24|341.75| 0.008|
|2014-04-24 08:12:24|2014-04-24|341.77| 0.012|
|2014-04-24 08:12:24|2014-04-24|341.75| 0.078|
|2014-04-24 08:12:57|2014-04-24|341.77|  0.09|
|2014-04-24 08:26:56|2014-04-24|341.74|  0.07|
|2014-04-24 08:33:54|2014-04-24|341.74|  0.06|
|2014-04-24 08:46:38|2014-04-24|341.77| 0.003|
|2014-04-24 08:46:38|2014-04-24|341.87| 0.021|
|2014-04-24 09:06:05|2014-04-24|342.54| 0.025|
|2014-04-24 09:20:34|2014-04-24| 343.0| 0.123|
|2014-04-25 10:28:29|2014-04-25| 343.0| 0.041|
|2014-04-25 04:16:38|2014-04-25|343.54|  0.06|
|2014-04-25 04:18:28|2014-04-25|344.21| 0.041|
|2014-04-26 07:40:19|2014-04-26|344.21|  0.03|
|2014-04-26 08:31:49|2014-04-26|344.23|  0.03|
|2014-04-26 08:32:13|2014-04-26|344.23|  0.07|
|2014-04-26 10:27:40|2014-04-26|344.21|  0.02|
+-------------------+----------+------+------+

df.registerTempTable("bitcoin")

sqlContext.sql("SELECT MIN(ts), MAX(ts) FROM bitcoin").show()

+-------------------+-------------------+                                       
|                _c0|                _c1|
+-------------------+-------------------+
|2014-04-24 04:55:11|2016-01-04 12:57:26|
+-------------------+-------------------+

sqlContext.sql("SELECT MIN(price), MAX(price) FROM bitcoin").show()

+---+------+
|_c0|   _c1|
+---+------+
|1.0|497.77|
+---+------+

sqlContext.sql("SELECT MIN(volume), MAX(volume) FROM bitcoin").show()

+-----+-----+                                                                   
|  _c0|  _c1|
+-----+-----+
|-25.0|120.0|
+-----+-----+

sqlContext.sql("SELECT sum(volume) FROM bitcoin").show()

+-----------------+                                                             
|              _c0|
+-----------------+
|280587.9324777317|
+-----------------+

sqlContext.sql("SELECT date, MIN(price) as Low, MAX(price) as High FROM bitcoin Group By date").show()

+----------+------+------+
|      date|   Low|  High|
+----------+------+------+
|2015-07-14|259.98|267.27|
|2015-07-15|259.73| 266.1|
|2015-03-01|219.04|225.48|
|2015-07-16|252.03|264.24|
|2015-11-20|296.38|304.67|
|2015-03-02|224.69|245.74|
|2015-07-17|249.12|258.08|
|2015-11-21|302.46|310.26|
|2014-04-30|322.23| 344.0|
|2015-03-03|235.12|252.34|
|2015-07-18|252.68|260.01|
|2015-03-04|240.99|255.33|
|2015-06-10|200.61|202.78|
|2015-07-19|250.66|255.64|
|2015-03-05| 238.9|251.95|
|2015-06-11|200.64|204.41|
|2015-03-06|242.74|253.81|
|2015-06-12| 201.6|204.46|
|2015-03-07|247.94| 253.6|
|2015-06-13|202.42|204.07|
+----------+------+------+


val rdd = rawRDD.map(_.split(",")).map {row => 
  val dt = new Date(row(0).toLong * 1000)
  (sdf2.format(dt), row(1).toFloat, row(2).toFloat)
}

rdd.take(10).foreach(println)

(2014-04-24,341.74,0.15)
(2014-04-24,341.74,0.05)
(2014-04-24,341.75,0.142)
(2014-04-24,341.75,0.008)
(2014-04-24,341.77,0.012)
(2014-04-24,341.75,0.078)
(2014-04-24,341.77,0.09)
(2014-04-24,341.74,0.07)
(2014-04-24,341.74,0.06)
(2014-04-24,341.77,0.003)

val dailyRDD = rdd.groupBy(x => x._1).map {x =>
  val xs = x._2.map(t => t._2)
  (x._1, xs.max, xs.min)
}

dailyRDD.take(10).foreach(println)

(2014-10-27,283.27,275.65)                                                      
(2014-06-16,456.13,433.0)
(2015-02-08,202.26,196.58)
(2014-12-16,275.6,261.18)
(2015-01-30,215.01,200.93)
(2014-05-02,327.5,322.34)
(2014-05-20,365.85,323.6)
(2014-09-13,373.92,363.97)
(2014-08-20,398.5,360.78)
(2014-11-23,301.08,296.28)
~~~



