### [Coinbase](https://en.wikipedia.org/wiki/Coinbase) using Spark
~~~
bin/spark-shell --master spark://localhost:7077 \
--packages com.databricks:spark-csv_2.10:1.3.0 \
--conf spark.serializer=org.apache.spark.serializer.KryoSerializer

import org.apache.spark.rdd.RDD
import org.apache.spark.storage.StorageLevel

val rawRDD = sc.textFile("/work/R/example/stocks/coinbaseUSD.csv.gz")

rawRDD.cache()

rawRDD.take(10).foreach(println)

1417412036,300.000000000000,0.010000000000
1417412423,300.000000000000,0.010000000000
1417415048,370.000000000000,0.010000000000
1417416612,370.000000000000,0.026555540000
1417498166,377.000000000000,0.010000000000
1417517949,377.750000000000,0.250000000000
1417517949,378.000000000000,3.750000000000
1417518257,378.000000000000,4.900000000000
1417518340,378.000000000000,5.200000000000
1417545780,378.000000000000,0.100000000000

rawRDD.count
res2: Long = 6209350


case class RawTicker(ts: Long, price: Float, volume: Float)

val rawDF = rawRDD.map(_.split(",")).map(row => RawTicker(row(0).toLong, row(1).toFloat, row(2).toFloat)).toDF()

rawDF.show()

+----------+------+----------+
|        ts| price|    volume|
+----------+------+----------+
|1417412036| 300.0|      0.01|
|1417412423| 300.0|      0.01|
|1417415048| 370.0|      0.01|
|1417416612| 370.0|0.02655554|
|1417498166| 377.0|      0.01|
|1417517949|377.75|      0.25|
|1417517949| 378.0|      3.75|
|1417518257| 378.0|       4.9|
|1417518340| 378.0|       5.2|
|1417545780| 378.0|       0.1|
|1417546703| 378.0|    0.7936|
|1417550521| 378.0|      0.01|
|1417584956| 377.9|      0.01|
|1417585904| 378.0| 0.0660842|
|1417586889| 378.0|0.01052422|
|1417631579| 378.0|      0.35|
|1417637186|377.01|       0.1|
|1417647358| 378.0|      0.01|
|1417657685| 377.1|      0.01|
|1417830085| 378.0|     0.015|
+----------+------+----------+

rawDF.registerTempTable("raw")

sqlContext.sql("SELECT count(*) FROM raw").show()

+-------+
|    _c0|
+-------+
|6209350|
+-------+

sqlContext.sql("SELECT MIN(ts), MAX(ts) FROM raw").show()

+----------+----------+
|       _c0|       _c1|
+----------+----------+
|1417412036|1453205656|
+----------+----------+

sqlContext.sql("SELECT MIN(price), MAX(price) FROM raw").show()

+------+------+
|   _c0|   _c1|
+------+------+
|109.87|499.99|
+------+------+

sqlContext.sql("SELECT MIN(volume), MAX(volume) FROM raw").show()

+------+-----+
|   _c0|  _c1|
+------+-----+
|1.0E-8|350.0|
+------+-----+

sqlContext.sql("SELECT sum(volume) FROM raw").show()

+------------------+
|               _c0|
+------------------+
|3120883.8762243288|
+------------------+


import java.util.Date
import java.util.TimeZone
import java.text.SimpleDateFormat

val sdf = new SimpleDateFormat("yyyy-MM-dd HH:mm:ss")
val sdf2 = new SimpleDateFormat("yyyy-MM-dd")

sdf.setTimeZone(TimeZone.getTimeZone("UTC"));
sdf2.setTimeZone(TimeZone.getTimeZone("UTC"));

case class TickerDate(ts: String, date: String, price: Float, volume: Float)

val dateDF = rawRDD.map(_.split(",")).map {row => 
  val dt = new Date(row(0).toLong * 1000)
  TickerDate(sdf.format(dt), sdf2.format(dt), row(1).toFloat, row(2).toFloat)
}.toDF()

dateDF.show()

+-------------------+----------+-----+----------+
|                 ts|      date|price|    volume|
+-------------------+----------+-----+----------+
|2011-09-13 13:53:36|2011-09-13|  5.8|       1.0|
|2011-09-13 13:53:44|2011-09-13| 5.83|       3.0|
|2011-09-13 13:53:49|2011-09-13|  5.9|       1.0|
|2011-09-13 13:53:54|2011-09-13|  6.0|      20.0|
|2011-09-13 14:32:53|2011-09-13| 5.95|   12.4521|
|2011-09-13 14:35:04|2011-09-13| 5.88|     7.458|
|2011-09-13 14:36:54|2011-09-13| 5.88|0.17688239|
|2011-09-13 14:54:23|2011-09-13| 5.76|     2.267|
|2011-09-13 15:31:38|2011-09-13| 5.65|     2.542|
|2011-09-13 19:32:59|2011-09-13| 5.92|      0.45|
|2011-09-13 19:34:29|2011-09-13| 5.95|    3.5786|
|2011-09-13 19:34:36|2011-09-13| 5.97|    4.4468|
|2011-09-14 07:00:00|2011-09-14| 5.58|  12.54864|
|2011-09-14 07:34:43|2011-09-14| 5.54| 3.4181776|
|2011-09-14 07:55:46|2011-09-14| 5.62|  0.458882|
|2011-09-14 08:31:40|2011-09-14| 5.57|  6.235448|
|2011-09-14 08:53:56|2011-09-14| 5.55|  0.335485|
|2011-09-14 08:54:02|2011-09-14| 5.56|  5.776566|
|2011-09-14 09:18:40|2011-09-14| 5.57|  4.335485|
|2011-09-14 09:37:06|2011-09-14| 5.61|  0.554861|
+-------------------+----------+-----+----------+


dateDF.registerTempTable("coinbase")

sqlContext.sql("SELECT MIN(ts), MAX(ts) FROM coinbase").show()

+-------------------+-------------------+
|                _c0|                _c1|
+-------------------+-------------------+
|2014-12-01 05:33:56|2016-01-19 12:14:16|
+-------------------+-------------------+

sqlContext.sql("SELECT date, MIN(price) as Low, MAX(price) as High FROM coinbase Group By date").show()

+----------+------+------+
|      date|   Low|  High|
+----------+------+------+
|2015-04-08|244.29|255.75|
|2015-07-14|286.25|297.78|
|2015-12-27|410.02|429.85|
|2015-04-09|239.02|248.16|
|2015-07-15|284.98|294.11|
|2015-12-28| 418.0| 429.9|
|2015-03-01|244.88| 262.0|
|2015-07-16| 275.0|292.78|
|2015-11-20|311.23|327.04|
|2015-12-29|419.31| 433.9|
|2015-03-02| 256.6| 279.8|
|2015-07-17|272.64|281.38|
|2015-11-21|316.33| 328.0|
|2015-03-03|267.07| 289.5|
|2015-07-18|276.34|282.71|
|2015-11-22| 321.0| 327.0|
|2015-03-04|267.39| 287.0|
|2015-06-10|227.98|230.45|
|2015-07-19| 275.0|278.48|
|2015-11-23| 322.0| 326.0|
+----------+------+------+



val rdd = rawRDD.map(_.split(",")).map {row => 
  val dt = new Date(row(0).toLong * 1000)
  (sdf2.format(dt), row(0).toLong, row(1).toFloat, row(2).toFloat)
}

rdd.take(10).foreach(println)

(2014-12-01,1417412036,300.0,0.01)
(2014-12-01,1417412423,300.0,0.01)
(2014-12-01,1417415048,370.0,0.01)
(2014-12-01,1417416612,370.0,0.02655554)
(2014-12-02,1417498166,377.0,0.01)
(2014-12-02,1417517949,377.75,0.25)
(2014-12-02,1417517949,378.0,3.75)
(2014-12-02,1417518257,378.0,4.9)
(2014-12-02,1417518340,378.0,5.2)
(2014-12-02,1417545780,378.0,0.1)

// to be optimized

val dailyRDD = rdd.groupBy(x => x._1)

dailyRDD.count
res28: Long = 381

dailyRDD.map {x =>
  val xs = x._2.map(t => t._3)
  val xss = x._2.toSeq.sortWith(_._2 < _._2)
  
  (x._1, xss(0)._3, xs.max, xs.min, xss(xss.size-1)._3, x._2.map(t => t._4).sum)
}.take(10).foreach(println)

(2015-01-08,360.0,360.0,264.81,288.99,10.350142)
(2015-01-13,260.0,260.0,260.0,260.0,1.0)
(2015-01-14,200.0,221.0,109.87,120.0,11.304797)
(2015-01-15,191.99,224.0,150.0,204.22,2.9773192)
(2015-01-16,210.98,225.5,189.0,199.46,4.6900125)
(2015-01-17,210.0,210.0,184.0,184.0,0.11199999)
(2015-01-19,210.0,225.51,210.0,225.51,0.41)
(2015-01-20,215.0,218.0,208.0,218.0,0.04)
(2015-01-21,219.0,225.51,219.0,225.51,0.13770722)
(2015-01-22,245.5,257.73,216.59,226.32,4.360002)

dailyRDD.map {x =>
  val xs = x._2.map(t => t._3)
  val xss = x._2.toSeq.sortWith(_._2 < _._2)
  
  (x._1, xss(0)._3, sdf.format(new Date(xss(0)._2 * 1000)), xs.max, xs.min, xss(xss.size-1)._3, sdf.format(new Date(xss(xss.size-1)._2 * 1000)), x._2.map(t => t._4).sum)
}.take(10).foreach(println)

(2015-01-08,360.0,2015-01-08 01:24:02,360.0,264.81,288.99,2015-01-08 20:19:53,10.350142)
(2015-01-13,260.0,2015-01-13 03:38:51,260.0,260.0,260.0,2015-01-13 03:38:51,1.0)
(2015-01-14,200.0,2015-01-14 00:01:26,221.0,109.87,120.0,2015-01-14 19:40:43,11.304797)
(2015-01-15,191.99,2015-01-15 01:35:08,224.0,150.0,204.22,2015-01-15 23:58:02,2.9773192)
(2015-01-16,210.98,2015-01-16 00:00:30,225.5,189.0,199.46,2015-01-16 23:04:23,4.6900125)
(2015-01-17,210.0,2015-01-17 01:58:43,210.0,184.0,184.0,2015-01-17 18:32:11,0.11199999)
(2015-01-19,210.0,2015-01-19 00:36:03,225.51,210.0,225.51,2015-01-19 03:49:55,0.41)
(2015-01-20,215.0,2015-01-20 18:13:09,218.0,208.0,218.0,2015-01-20 23:52:27,0.04)
(2015-01-21,219.0,2015-01-21 00:40:37,225.51,219.0,225.51,2015-01-21 23:04:45,0.13770722)
(2015-01-22,245.5,2015-01-22 01:09:18,257.73,216.59,226.32,2015-01-22 06:03:03,4.360002)


sqlContext.sql("SELECT MIN(ts) as First, MAX(ts) as Last, MAX(price) as High, MIN(price) as Low, SUM(volume) as Volume FROM coinbase WHERE date = '2015-01-08'").show()

+-------------------+-------------------+-----+------+------------------+
|              First|               Last| High|   Low|            Volume|
+-------------------+-------------------+-----+------+------------------+
|2015-01-08 01:24:02|2015-01-08 20:19:53|360.0|264.81|10.349999772384763|
+-------------------+-------------------+-----+------+------------------+

sqlContext.sql("SELECT price FROM coinbase WHERE ts = '2015-01-08 01:24:02'").show()

+-----+
|price|
+-----+
|360.0|
+-----+

sqlContext.sql("SELECT price FROM coinbase WHERE ts = '2015-01-08 20:19:53'").show()

+------+
| price|
+------+
|288.99|
+------+


dailyRDD.map {x =>
  val xs = x._2.map(t => t._3)
  val xss = x._2.toSeq.sortWith(_._2 < _._2)
  
  (x._1, xss(0)._3, xs.max, xs.min, xss(xss.size-1)._3, x._2.map(t => t._4).sum)
}.coalesce(1).map(x => x._1 + "," + x._2 + "," + x._3 + "," + x._4 + "," + x._5 + "," + x._6).saveAsTextFile("/work/R/example/stocks/coinbase-daily.csv")
~~~

