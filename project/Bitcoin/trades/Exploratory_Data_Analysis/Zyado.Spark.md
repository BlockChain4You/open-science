### Zyado Using Spark
~~~
bin/spark-shell --master spark://localhost:7077 \
--packages com.databricks:spark-csv_2.10:1.3.0 \
--conf spark.serializer=org.apache.spark.serializer.KryoSerializer

import org.apache.spark.rdd.RDD
import org.apache.spark.storage.StorageLevel

val rawRDD = sc.textFile("/work/R/example/stocks/zyadoEUR.csv.gz")

rawRDD.cache()

rawRDD.take(10).foreach(println)

1398372911,341.740000000000,0.150000000000
1398373075,341.740000000000,0.050000000000
1398377372,341.750000000000,0.142000000000
1398377372,341.750000000000,0.008000000000
1398384744,341.770000000000,0.012000000000
1398384744,341.750000000000,0.078000000000
1398384777,341.770000000000,0.090000000000
1398385616,341.740000000000,0.070000000000
1398386034,341.740000000000,0.060000000000
1398386798,341.770000000000,0.003000000000

rawRDD.count
Long = 1870266  


case class RawTicker(ts: Long, price: Float, volume: Float)

val rawDF = rawRDD.map(_.split(",")).map(row => RawTicker(row(0).toLong, row(1).toFloat, row(2).toFloat)).toDF()

rawDF.cache()

rawDF.show()

+----------+------+------+
|        ts| price|volume|
+----------+------+------+
|1398372911|341.74|  0.15|
|1398373075|341.74|  0.05|
|1398377372|341.75| 0.142|
|1398377372|341.75| 0.008|
|1398384744|341.77| 0.012|
|1398384744|341.75| 0.078|
|1398384777|341.77|  0.09|
|1398385616|341.74|  0.07|
|1398386034|341.74|  0.06|
|1398386798|341.77| 0.003|
|1398386798|341.87| 0.021|
|1398387965|342.54| 0.025|
|1398388834| 343.0| 0.123|
|1398436109| 343.0| 0.041|
|1398456998|343.54|  0.06|
|1398457108|344.21| 0.041|
|1398512419|344.21|  0.03|
|1398515509|344.23|  0.03|
|1398515533|344.23|  0.07|
|1398522460|344.21|  0.02|
+----------+------+------+


rawDF.registerTempTable("raw")

sqlContext.sql("SELECT count(*) FROM raw").show()

+-------+                                                                       
|    _c0|
+-------+
|1870266|
+-------+

sqlContext.sql("SELECT MIN(ts), MAX(ts) FROM raw").show()

+----------+----------+                                                         
|       _c0|       _c1|
+----------+----------+
|1398372911|1451913138|
+----------+----------+

sqlContext.sql("SELECT MIN(price), MAX(price) FROM raw").show()

+---+------+
|_c0|   _c1|
+---+------+
|1.0|497.77|
+---+------+

sqlContext.sql("SELECT MIN(volume), MAX(volume) FROM raw").show()

+-----+-----+
|  _c0|  _c1|
+-----+-----+
|-25.0|120.0|
+-----+-----+

sqlContext.sql("SELECT sum(volume) FROM raw").show()

+------------------+
|               _c0|
+------------------+
|280587.93247773155|
+------------------+


import java.util.Date
import java.util.TimeZone
import java.text.SimpleDateFormat

val sdf = new SimpleDateFormat("yyyy-MM-dd HH:mm:ss")
val sdf2 = new SimpleDateFormat("yyyy-MM-dd")

sdf.setTimeZone(TimeZone.getTimeZone("UTC"));
sdf2.setTimeZone(TimeZone.getTimeZone("UTC"));

case class TickerDate(ts: String, date: String, price: Float, volume: Float)

val dateDF = rawRDD.map(_.split(",")).map {row => 
  val dt = new Date(row(0).toLong * 1000)
  TickerDate(sdf.format(dt), sdf2.format(dt), row(1).toFloat, row(2).toFloat)
}.toDF()

dateDF.show()

+-------------------+----------+------+------+
|                 ts|      date| price|volume|
+-------------------+----------+------+------+
|2014-04-24 20:55:11|2014-04-24|341.74|  0.15|
|2014-04-24 20:57:55|2014-04-24|341.74|  0.05|
|2014-04-24 22:09:32|2014-04-24|341.75| 0.142|
|2014-04-24 22:09:32|2014-04-24|341.75| 0.008|
|2014-04-25 00:12:24|2014-04-25|341.77| 0.012|
|2014-04-25 00:12:24|2014-04-25|341.75| 0.078|
|2014-04-25 00:12:57|2014-04-25|341.77|  0.09|
|2014-04-25 00:26:56|2014-04-25|341.74|  0.07|
|2014-04-25 00:33:54|2014-04-25|341.74|  0.06|
|2014-04-25 00:46:38|2014-04-25|341.77| 0.003|
|2014-04-25 00:46:38|2014-04-25|341.87| 0.021|
|2014-04-25 01:06:05|2014-04-25|342.54| 0.025|
|2014-04-25 01:20:34|2014-04-25| 343.0| 0.123|
|2014-04-25 14:28:29|2014-04-25| 343.0| 0.041|
|2014-04-25 20:16:38|2014-04-25|343.54|  0.06|
|2014-04-25 20:18:28|2014-04-25|344.21| 0.041|
|2014-04-26 11:40:19|2014-04-26|344.21|  0.03|
|2014-04-26 12:31:49|2014-04-26|344.23|  0.03|
|2014-04-26 12:32:13|2014-04-26|344.23|  0.07|
|2014-04-26 14:27:40|2014-04-26|344.21|  0.02|
+-------------------+----------+------+------+


dateDF.registerTempTable("zyado")

sqlContext.sql("SELECT MIN(ts), MAX(ts) FROM zyado").show()

+-------------------+-------------------+
|                _c0|                _c1|
+-------------------+-------------------+
|2014-04-24 20:55:11|2016-01-04 13:12:18|
+-------------------+-------------------+

sqlContext.sql("SELECT date, MIN(price) as Low, MAX(price) as High FROM zyado Group By date").show()

+----------+------+------+
|      date|   Low|  High|
+----------+------+------+
|2015-07-14|259.98|267.32|
|2015-07-15|259.73| 266.1|
|2015-03-01|219.04|225.49|
|2015-07-16|252.03|265.76|
|2015-11-20|292.68|306.19|
|2015-03-02|222.81|244.53|
|2015-07-17|249.12|258.08|
|2015-11-21|301.67|310.26|
|2014-04-30|322.23| 344.0|
|2015-03-03|235.12|250.65|
|2015-07-18|252.68|260.01|
|2015-03-04|240.99|255.33|
|2015-06-10|200.61|202.78|
|2015-07-19|251.24|255.64|
|2015-03-05| 238.9|251.95|
|2015-06-11|200.64|204.41|
|2015-03-06|242.74|253.81|
|2015-06-12|202.15|204.46|
|2015-03-07|247.49| 253.6|
|2015-06-13| 201.6|204.07|
+----------+------+------+



val rdd = rawRDD.map(_.split(",")).map {row => 
  val dt = new Date(row(0).toLong * 1000)
  (sdf2.format(dt), row(0).toLong, row(1).toFloat, row(2).toFloat)
}

rdd.take(10).foreach(println)

(2014-04-24,1398372911,341.74,0.15)
(2014-04-24,1398373075,341.74,0.05)
(2014-04-24,1398377372,341.75,0.142)
(2014-04-24,1398377372,341.75,0.008)
(2014-04-25,1398384744,341.77,0.012)
(2014-04-25,1398384744,341.75,0.078)
(2014-04-25,1398384777,341.77,0.09)
(2014-04-25,1398385616,341.74,0.07)
(2014-04-25,1398386034,341.74,0.06)
(2014-04-25,1398386798,341.77,0.003)

// to be optimized

val dailyRDD = rdd.groupBy(x => x._1)

dailyRDD.count
res28: Long = 500

dailyRDD.map {x =>
  val xs = x._2.map(t => t._3)
  val xss = x._2.toSeq.sortWith(_._2 < _._2)

  (x._1, xss(0)._3, xs.max, xs.min, xss(xss.size-1)._3, x._2.map(t => t._4).sum)
}.take(10).foreach(println)

(2015-01-01,261.85,261.98,260.16,261.03,99.83593)
(2015-01-02,260.74,264.42,260.02,263.68,195.85349)
(2015-01-03,263.68,264.09,238.04,238.04,257.68472)
(2015-01-04,238.04,240.6,209.88,220.85,1581.9293)
(2015-01-05,220.85,233.57,220.85,231.03,410.1057)
(2015-01-06,230.9,244.15,229.73,242.97,368.6663)
(2015-01-07,242.96,255.27,239.25,250.18,407.21332)
(2015-01-08,250.25,250.28,241.85,242.06,217.96802)
(2015-01-09,241.91,249.77,241.04,248.8,221.95363)
(2015-01-10,248.41,248.96,232.54,233.47,466.29974)

dailyRDD.map {x =>
  val xs = x._2.map(t => t._3)
  val xss = x._2.toSeq.sortWith(_._2 < _._2)

  (x._1, xss(0)._3, sdf.format(new Date(xss(0)._2 * 1000)), xs.max, xs.min, xss(xss.size-1)._3, sdf.format(new Date(xss(xss.size-1)._2 * 1000)), x._2.map(t => t._4).sum)
}.take(10).foreach(println)

(2015-01-01,261.85,2015-01-01 14:30:36,261.98,260.16,261.03,2015-01-01 23:58:52,99.83593)
(2015-01-02,260.74,2015-01-02 00:00:46,264.42,260.02,263.68,2015-01-02 23:57:44,195.85349)
(2015-01-03,263.68,2015-01-03 00:00:47,264.09,238.04,238.04,2015-01-03 23:59:42,257.68472)
(2015-01-04,238.04,2015-01-04 00:00:28,240.6,209.88,220.85,2015-01-04 23:58:09,1581.9293)
(2015-01-05,220.85,2015-01-05 00:00:30,233.57,220.85,231.03,2015-01-05 23:59:54,410.1057)
(2015-01-06,230.9,2015-01-06 00:00:23,244.15,229.73,242.97,2015-01-06 23:58:24,368.6663)
(2015-01-07,242.96,2015-01-07 00:01:38,255.27,239.25,250.18,2015-01-07 23:55:27,407.21332)
(2015-01-08,250.25,2015-01-08 00:05:21,250.28,241.85,242.06,2015-01-08 23:56:25,217.96802)
(2015-01-09,241.91,2015-01-09 00:00:08,249.77,241.04,248.8,2015-01-09 23:57:43,221.95363)
(2015-01-10,248.41,2015-01-10 00:00:37,248.96,232.54,233.47,2015-01-10 23:57:45,466.29974)


sqlContext.sql("SELECT MIN(ts) as First, MAX(ts) as Last, MAX(price) as High, MIN(price) as Low, SUM(volume) as Volume FROM zyado WHERE date = '2015-01-01'").show()

+-------------------+-------------------+------+------+-----------------+
|              First|               Last|  High|   Low|           Volume|
+-------------------+-------------------+------+------+-----------------+
|2015-01-01 14:30:36|2015-01-01 23:58:52|261.98|260.16|99.83595305731433|
+-------------------+-------------------+------+------+-----------------+

sqlContext.sql("SELECT price FROM zyado WHERE ts = '2015-01-01 14:30:36'").show()

+------+
| price|
+------+
|261.85|
+------+

sqlContext.sql("SELECT price FROM zyado WHERE ts = '2015-01-01 23:58:52'").show()

+------+
| price|
+------+
|261.03|
+------+


dailyRDD.map {x =>
  val xs = x._2.map(t => t._3)
  val xss = x._2.toSeq.sortWith(_._2 < _._2)

  (x._1, xss(0)._3, xs.max, xs.min, xss(xss.size-1)._3, x._2.map(t => t._4).sum)
}.coalesce(1).map(x => x._1 + "," + x._2 + "," + x._3 + "," + x._4 + "," + x._5 + "," + x._6).saveAsTextFile("/work/R/example/stocks/zyado-daily.csv")
~~~
