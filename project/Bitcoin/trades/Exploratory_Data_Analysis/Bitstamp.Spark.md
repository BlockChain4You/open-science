### [Bitstamp](https://en.wikipedia.org/wiki/Bitstamp) using Spark
~~~
bin/spark-shell --master spark://localhost:7077 \
--packages com.databricks:spark-csv_2.10:1.3.0 \
--conf spark.serializer=org.apache.spark.serializer.KryoSerializer

import org.apache.spark.rdd.RDD
import org.apache.spark.storage.StorageLevel

val rawRDD = sc.textFile("/work/R/example/stocks/bitstampUSD.csv.gz")

rawRDD.cache()

rawRDD.take(10).foreach(println)

1315922016,5.800000000000,1.000000000000
1315922024,5.830000000000,3.000000000000
1315922029,5.900000000000,1.000000000000
1315922034,6.000000000000,20.000000000000
1315924373,5.950000000000,12.452100000000
1315924504,5.880000000000,7.458000000000
1315924614,5.880000000000,0.176882380000
1315925663,5.760000000000,2.267000000000
1315927898,5.650000000000,2.542000000000
1315942379,5.920000000000,0.450000000000

rawRDD.count
res1: Long = 8671372


case class RawTicker(ts: Long, price: Float, volume: Float)

val rawDF = rawRDD.map(_.split(",")).map(row => RawTicker(row(0).toLong, row(1).toFloat, row(2).toFloat)).toDF()

rawDF.show()

+----------+-----+----------+
|        ts|price|    volume|
+----------+-----+----------+
|1315922016|  5.8|       1.0|
|1315922024| 5.83|       3.0|
|1315922029|  5.9|       1.0|
|1315922034|  6.0|      20.0|
|1315924373| 5.95|   12.4521|
|1315924504| 5.88|     7.458|
|1315924614| 5.88|0.17688239|
|1315925663| 5.76|     2.267|
|1315927898| 5.65|     2.542|
|1315942379| 5.92|      0.45|
|1315942469| 5.95|    3.5786|
|1315942476| 5.97|    4.4468|
|1315983600| 5.58|  12.54864|
|1315985683| 5.54| 3.4181776|
|1315986946| 5.62|  0.458882|
|1315989100| 5.57|  6.235448|
|1315990436| 5.55|  0.335485|
|1315990442| 5.56|  5.776566|
|1315991920| 5.57|  4.335485|
|1315993026| 5.61|  0.554861|
+----------+-----+----------+


rawDF.registerTempTable("raw")

sqlContext.sql("SELECT count(*) FROM raw").show()
+-------+
|    _c0|
+-------+
|8671372|
+-------+

sqlContext.sql("SELECT MIN(ts), MAX(ts) FROM raw").show()

+----------+----------+
|       _c0|       _c1|
+----------+----------+
|1315922016|1453203920|
+----------+----------+

sqlContext.sql("SELECT MIN(price), MAX(price) FROM raw").show()

+----+------+
| _c0|   _c1|
+----+------+
|2.22|1163.0|
+----+------+

sqlContext.sql("SELECT MIN(volume), MAX(volume) FROM raw").show()

+----------+-------+
|       _c0|    _c1|
+----------+-------+
|-33.059498|2932.84|
+----------+-------+

sqlContext.sql("SELECT sum(volume) FROM raw").show()
+--------------------+
|                 _c0|
+--------------------+
|1.6327320765607655E7|
+--------------------+



import java.util.Date
import java.util.TimeZone
import java.text.SimpleDateFormat

val sdf = new SimpleDateFormat("yyyy-MM-dd HH:mm:ss")
val sdf2 = new SimpleDateFormat("yyyy-MM-dd")

sdf.setTimeZone(TimeZone.getTimeZone("UTC"));
sdf2.setTimeZone(TimeZone.getTimeZone("UTC"));

case class TickerDate(ts: String, date: String, price: Float, volume: Float)

val dateDF = rawRDD.map(_.split(",")).map {row => 
  val dt = new Date(row(0).toLong * 1000)
  TickerDate(sdf.format(dt), sdf2.format(dt), row(1).toFloat, row(2).toFloat)
}.toDF()

dateDF.show()

+-------------------+----------+-----+----------+
|                 ts|      date|price|    volume|
+-------------------+----------+-----+----------+
|2011-09-13 13:53:36|2011-09-13|  5.8|       1.0|
|2011-09-13 13:53:44|2011-09-13| 5.83|       3.0|
|2011-09-13 13:53:49|2011-09-13|  5.9|       1.0|
|2011-09-13 13:53:54|2011-09-13|  6.0|      20.0|
|2011-09-13 14:32:53|2011-09-13| 5.95|   12.4521|
|2011-09-13 14:35:04|2011-09-13| 5.88|     7.458|
|2011-09-13 14:36:54|2011-09-13| 5.88|0.17688239|
|2011-09-13 14:54:23|2011-09-13| 5.76|     2.267|
|2011-09-13 15:31:38|2011-09-13| 5.65|     2.542|
|2011-09-13 19:32:59|2011-09-13| 5.92|      0.45|
|2011-09-13 19:34:29|2011-09-13| 5.95|    3.5786|
|2011-09-13 19:34:36|2011-09-13| 5.97|    4.4468|
|2011-09-14 07:00:00|2011-09-14| 5.58|  12.54864|
|2011-09-14 07:34:43|2011-09-14| 5.54| 3.4181776|
|2011-09-14 07:55:46|2011-09-14| 5.62|  0.458882|
|2011-09-14 08:31:40|2011-09-14| 5.57|  6.235448|
|2011-09-14 08:53:56|2011-09-14| 5.55|  0.335485|
|2011-09-14 08:54:02|2011-09-14| 5.56|  5.776566|
|2011-09-14 09:18:40|2011-09-14| 5.57|  4.335485|
|2011-09-14 09:37:06|2011-09-14| 5.61|  0.554861|
+-------------------+----------+-----+----------+


dateDF.registerTempTable("bitstamp")

sqlContext.sql("SELECT MIN(ts), MAX(ts) FROM bitstamp").show()

+-------------------+-------------------+
|                _c0|                _c1|
+-------------------+-------------------+
|2011-09-13 13:53:36|2016-01-19 11:45:20|
+-------------------+-------------------+

sqlContext.sql("SELECT date, MIN(price) as Low, MAX(price) as High FROM bitstamp Group By date").show()

+----------+------+------+
|      date|   Low|  High|
+----------+------+------+
|2012-02-12|  5.55|  5.78|
|2012-06-27|  6.34|  6.68|
|2012-10-31| 10.66|  11.0|
|2013-08-06| 97.07| 98.98|
|2013-12-10|895.01| 989.6|
|2014-01-20| 815.0| 845.0|
|2015-04-08|243.06|254.96|
|2015-07-14|286.02|297.13|
|2015-12-27| 410.5|425.42|
|2012-02-13|   5.5|  5.79|
|2012-06-28|  5.99|  6.54|
|2013-08-07|  95.5| 98.32|
|2013-12-11| 804.0| 988.0|
|2014-01-21| 814.0| 834.5|
|2015-04-09|238.47| 246.3|
|2015-07-15|284.29| 293.7|
|2015-12-28|417.01|429.86|
|2012-02-14|  4.56|   5.8|
|2012-05-20|  5.03|  5.08|
|2012-06-29|  6.49|  6.63|
+----------+------+------+



val rdd = rawRDD.map(_.split(",")).map {row => 
  val dt = new Date(row(0).toLong * 1000)
  (sdf2.format(dt), row(0).toLong, row(1).toFloat, row(2).toFloat)
}

rdd.take(10).foreach(println)

(2011-09-13,1315922016,5.8,1.0)
(2011-09-13,1315922024,5.83,3.0)
(2011-09-13,1315922029,5.9,1.0)
(2011-09-13,1315922034,6.0,20.0)
(2011-09-13,1315924373,5.95,12.4521)
(2011-09-13,1315924504,5.88,7.458)
(2011-09-13,1315924614,5.88,0.17688239)
(2011-09-13,1315925663,5.76,2.267)
(2011-09-13,1315927898,5.65,2.542)
(2011-09-13,1315942379,5.92,0.45)

// to be optimized

val dailyRDD = rdd.groupBy(x => x._1)

dailyRDD.count
res28: Long = 1569

dailyRDD.map {x =>
  val xs = x._2.map(t => t._3)
  val xss = x._2.toSeq.sortWith(_._2 < _._2)
  
  (x._1, xss(0)._3, xs.max, xs.min, xss(xss.size-1)._3, x._2.map(t => t._4).sum)
}.take(10).foreach(println)

(2015-01-01,321.0,321.0,312.6,313.81,3087.431)
(2015-01-02,313.82,317.01,311.96,315.42,3468.2788)
(2015-01-03,315.42,316.58,280.0,282.0,21752.941)
(2015-01-04,280.0,289.39,255.0,264.0,41442.383)
(2015-01-05,264.55,280.0,264.07,276.8,9528.268)
(2015-01-09,296.64,305.0,272.45,293.97,9914.188)
(2015-01-10,293.89,295.0,271.03,275.59,29448.854)
(2015-01-11,275.6,280.94,262.08,266.39,12758.789)
(2015-01-12,266.34,272.43,263.54,267.42,10478.225)
(2015-01-13,267.1,268.15,216.0,227.0,60557.16)

dailyRDD.map {x =>
  val xs = x._2.map(t => t._3)
  val xss = x._2.toSeq.sortWith(_._2 < _._2)
  
  (x._1, xss(0)._3, sdf.format(new Date(xss(0)._2 * 1000)), xs.max, xs.min, xss(xss.size-1)._3, sdf.format(new Date(xss(xss.size-1)._2 * 1000)), x._2.map(t => t._4).sum)
}.take(10).foreach(println)

(2015-01-01,321.0,2015-01-01 00:00:22,321.0,312.6,313.81,2015-01-01 23:59:00,3087.431)
(2015-01-02,313.82,2015-01-02 00:01:29,317.01,311.96,315.42,2015-01-02 23:59:04,3468.2788)
(2015-01-03,315.42,2015-01-03 00:00:07,316.58,280.0,282.0,2015-01-03 23:59:59,21752.941)
(2015-01-04,280.0,2015-01-04 00:00:00,289.39,255.0,264.0,2015-01-04 23:58:35,41442.383)
(2015-01-05,264.55,2015-01-05 00:00:12,280.0,264.07,276.8,2015-01-05 09:12:25,9528.268)
(2015-01-09,296.64,2015-01-09 21:05:04,305.0,272.45,293.97,2015-01-09 23:59:03,9914.188)
(2015-01-10,293.89,2015-01-10 00:00:09,295.0,271.03,275.59,2015-01-10 23:59:43,29448.854)
(2015-01-11,275.6,2015-01-11 00:00:26,280.94,262.08,266.39,2015-01-11 23:59:46,12758.789)
(2015-01-12,266.34,2015-01-12 00:00:00,272.43,263.54,267.42,2015-01-12 23:59:57,10478.225)
(2015-01-13,267.1,2015-01-13 00:00:28,268.15,216.0,227.0,2015-01-13 23:59:59,60557.16)


sqlContext.sql("SELECT MIN(ts), MAX(ts), MAX(price) as High, MIN(price), SUM(volume) as Low FROM bitstamp WHERE date = '2015-01-01'").show()

+-------------------+-------------------+-----+-----+-----------------+
|                _c0|                _c1| High|  _c3|              Low|
+-------------------+-------------------+-----+-----+-----------------+
|2015-01-01 00:00:22|2015-01-01 23:59:00|321.0|312.6|3087.436549626096|
+-------------------+-------------------+-----+-----+-----------------+

sqlContext.sql("SELECT price FROM bitstamp WHERE ts = '2015-01-01 00:00:22'").show()

+-----+
|price|
+-----+
|321.0|
+-----+

sqlContext.sql("SELECT price FROM bitstamp WHERE ts = '2015-01-01 23:59:00'").show()

+------+
| price|
+------+
|313.81|
+------+


dailyRDD.map {x =>
  val xs = x._2.map(t => t._3)
  val xss = x._2.toSeq.sortWith(_._2 < _._2)
  
  (x._1, xss(0)._3, xs.max, xs.min, xss(xss.size-1)._3, x._2.map(t => t._4).sum)
}.coalesce(1).map(x => x._1 + "," + x._2 + "," + x._3 + "," + x._4 + "," + x._5 + "," + x._6).saveAsTextFile("/work/R/example/stocks/bitstamp-daily.csv")
~~~
